# Референсная реализация протокола InstantPay 1.0

**Версия 0.1 — 31 июля 2025**

---

## 1 · Цель

Создать открытый репозиторий, демонстрирующий взаимодействие dApp и кошелька через **InstantPay 1.0**. Репозиторий должен:

1. Опубликовать **npm‑пакет** `instantpay-core`, реализующий типизированный API `window.tonkeeper.instantPay`.
2. Создать **demo‑dApp**, демонстрирующий все возможности InstantPay и служащий площадкой для тестов и демонстрации.
3. Реализовать **mock‑кошелёк**, который показывает интеграцию InstantPay со стороны кошелька и автоматически подключается, если реального кошелька нет.
4. Сохранить чёткое разделение **бизнес‑логики** и **UI**, чтобы код был максимально понятен разработчикам dApp, кошельков и самого пакета.

---

## 2 · Границы проекта

|  Входит                                         |  Не входит             |
| ----------------------------------------------- | ---------------------- |
| Mock‑кошелёк (выступаект как пример реализации) | Хранение сид‑фраз      |
| Демо dApp который реализует все фичи            | Полноценный e‑commerce |
| Пакет `instantpay-core` (типы, валидация)       | Выпуск Jetton          |
| CI: lint, тесты, сборка                         | Маркетинговый сайт     |

---

## 3 · Архитектура

```text
repo/
 ├─ packages/
 │   ├─ protocol/           # JSON‑схемы и генератор TS‑типов
 │   ├─ sdk/                # ядро: валидация, события, типы
 │   ├─ wallet-mock/        # mock‑кошелёк на Solid
 │   └─ dapp-demo/          # demo‑dApp на Solid
 ├─ docs/
 └─ .github/
```

| Пакет               | Назначение                                               | Технологии                            |
| ------------------- | -------------------------------------------------------- | ------------------------------------- |
| **protocol**        | JSON Schema описания API + генерация TS‑типов            | JSON Schema, ts-json-schema-generator |
| **instantpay-core** | Типы, валидация, события (использует типы из `protocol`) | TypeScript                            |
| **wallet-mock**     | Заглушка‑кошелёк (Solid UI)                              | TypeScript, SolidJS, Vite             |
| **dapp-demo**       | UI‑демо для всех сценариев                               | TypeScript, SolidJS, Vite             |

---

## 4 · User Stories

| ID           | Роль / Persona              | User Story                                                                                                                                                                     | Acceptance Criteria                                                                                                                                                                                                                                           |
| ------------ | --------------------------- | ------------------------------------------------------------------------------------------------------------------------------------------------------------------------------ | ------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------- |
| **SDK**      | Разработчик dApp/кошелька   | *Как разработчик, я хочу установить пакет ********`@tonkeeper/instantpay-sdk`********, чтобы сразу получить типизированный API ********`window.tonkeeper.instantPay`********.* | – `npm i @tonkeeper/instantpay-sdk` завершается без peer‑warning’ов.– В IDE доступны все TS‑типы, сгенерированные из `protocol`.                                                                                                                              |
| **DEMO**     | Начинающий разработчик dApp | *Как новичок, я хочу запустить demo dApp и увидеть все сценарии протокола (success, cancel, limit, jetton), чтобы понять, как интегрироваться.*                                | – `npm install` и `npm start` поднимают локальный сервер без дополнительных шагов.– На странице отображается **Event Logs** — реактивный список всех событий InstantPay.– UI показывает **статус подключения**: «Real Wallet», «Mock Wallet» или «No Wallet». |
| **MOCK**     | Разработчик кошелька        | *Как разработчик кошелька, я хочу изучить mock‑реализацию, чтобы понять, как интегрировать InstantPay со стороны кошелька.*                                                    | – Объект `window.tonkeeper.instantPay` полностью реализован и покрывает все сценарии (подтверждение, отмена, лимит, concurrent‑error, jetton).– Mock‑UI содержит бейдж «Mock Wallet» и предоставляет интерфейс для подтверждения/отмены транзакций.           |
| **FALLBACK** | Пользователь без кошелька   | *Как пользователь, у которого нет установленного кошелька, я хочу всё равно протестировать dApp, чтобы увидеть, как это будет работать.*                                       | – При отсутствии `window.tonkeeper?.instantPay` demo dApp автоматически подключает mock‑кошелёк.– При наличии настоящего кошелька mock не активируется.– UI отображает уведомление о режиме подключения.                                                      |

---

## 5 · Engineering Principles

1. **Modern stack only.** Используем актуальные версии экосистемы: Node LTS‑1, TypeScript ≥ 5.x, Vite ≥ 5, Solid ≥ 1.8. Зависимость, не обновлявшаяся более 12 месяцев, требует обоснования в PR.
2. **Simplicity by default.** Новая абстракция или внешняя библиотека добавляется лишь при явной пользе (читабельность, тестируемость, производительность). Овер‑инжиниринг считается дефектом ревью.
3. **Single source of truth.** Все изменения API начинаются с правки JSON Schema в `protocol/`; CI проверяет отсутствие рассинхрона с сгенерированными типами.
